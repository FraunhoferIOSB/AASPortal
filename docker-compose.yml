services:
  aasportal-users:
    image: mongo
    container_name: aasportal-users
    restart: always
    ports:
      - 27017:27017
    volumes:
      #persist db data (users remain after restart)
      - mongodata:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=aas-server
      - MONGO_INITDB_ROOT_PASSWORD=aas-server
      - MONGO_INITDB_DATABASE=aasportal-users

  aasportal-index:
    image: mariadb:latest
    container_name: aasportal-index
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      interval: 30s
      retries: 3
      test:
        [
          "CMD",
          "healthcheck.sh",
          "--su-mysql",
          "--connect",
          "--innodb_initialized"
        ]
      timeout: 30s
    volumes:
      - ./projects/aasportal-index/schema.sql:/docker-entrypoint-initdb.d/1.sql
      - sqldata:/var/lib/mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: db>D6~M$4Â§Y:sChh
      MYSQL_DATABASE: aas-index
      MYSQL_USER: aas-server
      MYSQL_PASSWORD: aas-server
    ports:
      - 3306:3306

  aas-server:
    container_name: aas-server
    build:
      context: .
      dockerfile: ./Dockerfile.aas-server
    environment:
      - USER_STORAGE=mongodb://aasportal-users:27017/aasportal-users
  
  aas-portal:
    container_name: aas-portal
    build:
      context: .
      dockerfile: ./Dockerfile.aas-portal
    restart: always
    ports:
      - 80:80
volumes:
  mongodata:
  sqldata: